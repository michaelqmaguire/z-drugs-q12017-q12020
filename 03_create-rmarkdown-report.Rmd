---
title: "Z Drugs Q1 2017 - Q1 2020"
author: "Michael Maguire, MS"
date: "3/15/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Request Prompt:

Can you please cut the SDUD data to get only prescriptions for eszopiclone (Lunesta), zaleplon (Sonata), and zolpidem (Ambien, Ambien CR, Edluar, Intermezzo, Zolpimist) from Q12017 to Q12020 (each state)? Please include those that have suppressed records too.

### Load libraries

```{r libload, message = FALSE}
library(dplyr)
library(ggplot2)
library(hrbrthemes)
library(purrr)
library(readr)
library(stringr)
library(tidylog)
library(viridis)
```

### Step 1: Pull in SDUD dataset.

Note: location of data set is a personal directory, so I have masked it.

```{r locload, include = FALSE}
loc <- "C:\\Users\\michaelqmaguire2\\Dropbox (UFL)\\01_projects\\us-medicaid-drug-utilization\\us-medicaid-drug-utilziation\\data\\clean\\medicaid-sdud-2000-2020.rds"
```

```{r sdudload, echo = TRUE}
sdud_2017_2020 <-
  read_rds(
    file = loc
  ) %>%
  filter(year %in% c(2017:2019) | year == 2020 & quarter == 1)
```

Examine years and quarters to ensure the correct period is pulled.

```{r yrqtrcheck, echo = TRUE}
sdud_2017_2020 %>%
  distinct(year, quarter) %>%
  arrange(year, desc(quarter))
```

### Step 2: Flag records containing generic name.

```{r genflag, echo = TRUE}
sdud_2017_2020_gennmes <- 
  sdud_2017_2020 %>%
  mutate(
    eszcopiclone_flag = case_when(
      str_detect(string = gennme_c, pattern = regex("eszopiclone", ignore_case = TRUE)) ~ "1",
      TRUE ~ "0"
    ),
    zaleplon_flag = case_when(
      str_detect(string = gennme_c, pattern = regex("zaleplon", ignore_case = TRUE)) ~ "1",
      TRUE ~ "0"
    ),
    zolpidem_flag = case_when(
      str_detect(string = gennme_c, pattern = regex("zolpidem", ignore_case = TRUE)) ~ "1",
      TRUE ~ "0"
    )
  )
```

Checking flags.

```{r flagcheck, echo = TRUE}
sdud_2017_2020_gennmes %>%
  select(eszcopiclone_flag, zaleplon_flag, zolpidem_flag) %>%
  map(., janitor::tabyl)
```

### Step 3: Aggregate by state, year, quarter and sum.

```{r aggin, echo = TRUE}
# Filter off on flags created above.
sdud_2017_2020_z_flags <-
  sdud_2017_2020_gennmes %>%
  filter(
    eszcopiclone_flag == "1" | zaleplon_flag == "1" | zolpidem_flag == "1"
  )
# Create data set containing generic name, brand name, and ndc number.
ndc_gen_brand_names <- 
  sdud_2017_2020_z_flags %>%
  distinct(gennme_c, prodnme, ndc)
# Examine data set.
ndc_gen_brand_names
# Create aggregate by state, year, quarter, and suppression.
sdud_2017_2020_zdrugs <- 
  sdud_2017_2020_z_flags %>%
    group_by(state, year, quarter, suppression_used) %>%
    summarize(total_prescriptions = sum(number_of_prescriptions))
# Create aggregate by state, year, quarter, generic name, and suppression. 
sdud_2017_2020_zdrugs_rx <-
  sdud_2017_2020_z_flags %>%
    group_by(state, year, quarter, gennme_c, suppression_used) %>%
    summarize(total_prescriptions = sum(number_of_prescriptions))
```

### Step 4: Plot number of prescriptions over time.

```{r plots, echo = TRUE, fig.width = 12, fig.height = 8}
# Plot showing number of prescriptions by year and quarter.
ggplot(data = sdud_2017_2020_zdrugs) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions), fill = "forestgreen", alpha = 0.95) +
    scale_y_continuous(labels = scales::comma) + 
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Year and Quarter") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    theme(
      axis.text.x = element_text(color = "black"),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 10),
      axis.title.y = element_text(color = "black", size = 10),
    ) +
    coord_cartesian(expand = FALSE)
# Plot showing number of prescriptions by year, quarter, and generic name.
ggplot(data = sdud_2017_2020_zdrugs_rx) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions, fill = gennme_c)) +
    scale_fill_viridis_d(direction = -1) +
    scale_y_continuous(labels = scales::comma) +
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Generic Name, Year, and Quarter") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    labs(fill = "Generic Name") +
    theme(
      axis.text.x = element_text(color = "black"),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 12),
      axis.title.y = element_text(color = "black", size = 12)
    ) +
    coord_cartesian(expand = FALSE)
```
```{r plotrx, fig.height = 12, fig.width = 16}
# Plot showing number of prescriptions by year, quarter, and state.
ggplot(data = sdud_2017_2020_zdrugs) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions, fill = state), alpha = 0.95) +
    scale_fill_viridis_d() +
    scale_y_continuous(labels = scales::comma) + 
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Year, Quarter, and State") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    theme(
      axis.text.x = element_text(color = "black", angle = 90, size = 10, hjust = 0.25, vjust = 0.25),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 10),
      axis.title.y = element_text(color = "black", size = 10),
      legend.position = "none"
    ) +
    facet_wrap(~state) +
    coord_cartesian(expand = FALSE)
```
## JHC noticed GA has missing observations in 2018.

Repeat process without GA records.

### Step 5: Aggregate by state, year, quarter and sum, without GA.

```{r aggin_rm_ga, echo = TRUE}
# Filter off on flags created above.
sdud_2017_2020_z_flags_rm_ga <-
  sdud_2017_2020_gennmes %>%
  filter(
    (eszcopiclone_flag == "1" | zaleplon_flag == "1" | zolpidem_flag == "1") & state != "ga"
  )
# Create data set containing generic name, brand name, and ndc number.
ndc_gen_brand_names_rm_ga <- 
  sdud_2017_2020_z_flags_rm_ga %>%
  distinct(gennme_c, prodnme, ndc)
# Examine data set.
ndc_gen_brand_names_rm_ga
# Create aggregate by state, year, quarter, and suppression.
sdud_2017_2020_zdrugs_rm_ga <- 
  sdud_2017_2020_z_flags_rm_ga %>%
    group_by(state, year, quarter, suppression_used) %>%
    summarize(total_prescriptions = sum(number_of_prescriptions))
# Create aggregate by state, year, quarter, generic name, and suppression. 
sdud_2017_2020_zdrugs_rx_rm_ga <-
  sdud_2017_2020_z_flags_rm_ga %>%
    group_by(state, year, quarter, gennme_c, suppression_used) %>%
    summarize(total_prescriptions = sum(number_of_prescriptions))
```

### Step 6: Plot number of prescriptions over time, without GA.

```{r plots_rm_ga, echo = TRUE, fig.width = 12, fig.height = 8}
# Plot showing number of prescriptions by year and quarter.
ggplot(data = sdud_2017_2020_zdrugs_rm_ga) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions), fill = "forestgreen", alpha = 0.95) +
    scale_y_continuous(labels = scales::comma) + 
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Year and Quarter") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    theme(
      axis.text.x = element_text(color = "black"),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 10),
      axis.title.y = element_text(color = "black", size = 10),
    ) +
    coord_cartesian(expand = FALSE)
# Plot showing number of prescriptions by year, quarter, and generic name.
ggplot(data = sdud_2017_2020_zdrugs_rx_rm_ga) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions, fill = gennme_c)) +
    scale_fill_viridis_d(direction = -1) +
    scale_y_continuous(labels = scales::comma) +
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Generic Name, Year, and Quarter") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    labs(fill = "Generic Name") +
    theme(
      axis.text.x = element_text(color = "black"),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 12),
      axis.title.y = element_text(color = "black", size = 12)
    ) +
    coord_cartesian(expand = FALSE)
```
```{r plotrx_rm_ga, fig.height = 12, fig.width = 16}
# Plot showing number of prescriptions by year, quarter, and state.
ggplot(data = sdud_2017_2020_zdrugs_rm_ga) +
  geom_col(aes(x = paste0(year, "-", quarter), y = total_prescriptions, fill = state), alpha = 0.95) +
    scale_fill_viridis_d() +
    scale_y_continuous(labels = scales::comma) + 
    theme_ipsum_rc(axis_title_just = "ct") +
    ggtitle("Number of Prescriptions by Year, Quarter, and State") +
    xlab("Year-Quarter") +
    ylab("Total Number of Prescriptions") +
    theme(
      axis.text.x = element_text(color = "black", angle = 90, size = 10, hjust = 0.25, vjust = 0.25),
      axis.text.y = element_text(color = "black"),
      axis.title.x = element_text(color = "black", size = 10),
      axis.title.y = element_text(color = "black", size = 10),
      legend.position = "none"
    ) +
    facet_wrap(~state) +
    coord_cartesian(expand = FALSE)
```